{% extends 'main_page.html' %}

{% block title %}–ü–µ—Ä–µ–≤–µ–¥–∏ —Å–ª–æ–≤–∞ | –ò–≥—Ä—ã –≤ —Å–ª–æ–≤–∞{% endblock %}

{% block content %}
<main class="container mx-auto p-4">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <section class="text-center my-8">
    <h1 class="text-3xl font-bold mb-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –ü–µ—Ä–µ–≤–µ–¥–∏ —Å–ª–æ–≤–∞</h1>
    <p class="mb-6 text-lg">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä—ã —Å–ª–æ–≤ –Ω–∞ –¥–≤—É—Ö —è–∑—ã–∫–∞—Ö.</p>
  </section>
  <div class="flex justify-center items-center mb-4 gap-4 text-lg font-semibold">
    <div id="user-name" class="text-blue-700">{{ user.username }}</div>
    <div id="lifes" class="text-red-600">‚ù§Ô∏è {{ user.lifes }}</div>
    <div id="score" class="text-green-600">–ë–∞–ª–ª—ã: 0</div>
  </div>

  <div id="error-message" class="text-red-600 font-bold text-center mb-4 opacity-0 transition-opacity duration-300">
    –û—à–∏–±–∫–∞!
  </div>
  <!-- –î–≤–∞ —Å—Ç–æ–ª–±—Ü–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="space-y-4">

      {% for word in german_list %}

      <button data-id="{{ word.id }}"  class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-md">
        {% if word.type == 'Noun' %}
          {{ word.article }} {{ word.word}} ({{word.id}})
        {% elif word.type == 'Verb' %}
          {{ word.word}} ({{word.id}})
        {% endif%}
      </button>
      {% endfor %}
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="space-y-4">
     {% for word in russian_list %}
      <button data-id="{{ word.id }}"  class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-md">
        {{ word.word_translate }}
      </button>
    {% endfor %}
    </div>
    <!-- –ö–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –∏ "–°—Ç–æ–ø", —Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
    <div id="game-controls" class="flex justify-center gap-4 mt-8 hidden">
      <button id="continue-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
      <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">
        –°—Ç–æ–ø
      </button>
    </div>
    <div id="output" class="mt-6 text-xl font-semibold text-center text-gray-800"></div>
  </section>
</main>
{% endblock %}

{% block scripts %}



<!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ—è–≤—è—Ç—Å—è –ø–æ–∑–∂–µ) -->
<div id="controls" class="flex justify-center gap-4 mt-6 hidden">
  <button id="continue-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">–°—Ç–æ–ø</button>
</div>
<script>
console.log('üî• –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
const limit = {{ limit }};
document.addEventListener('DOMContentLoaded', function () {
  const germanButtons = document.querySelectorAll('.md\\:grid-cols-2 > div:nth-child(1) button');
  const russianButtons = document.querySelectorAll('.md\\:grid-cols-2 > div:nth-child(2) button');
  const lifesDiv = document.getElementById('lifes');
  const scoreDiv = document.getElementById('score');
  const gameControls = document.getElementById('game-controls');
  const stopBtn = document.getElementById('stop-btn');
  const continueBtn = document.getElementById('continue-btn');
  const errorMsg = document.getElementById('error-message');

  let selectedGerman = null;
  let selectedRussian = null;
  let lifes = parseInt(lifesDiv.textContent.replace(/[^\d]/g, '')) || 3;
  let score = 0;

  function updateLifesAndScore() {
    lifesDiv.innerHTML = `‚ù§Ô∏è ${lifes}`;
    scoreDiv.innerHTML = `–ë–∞–ª–ª—ã: ${score}`;
  }

  function resetSelections() {
    if (selectedGerman) selectedGerman.classList.remove('bg-blue-800');
    if (selectedRussian) selectedRussian.classList.remove('bg-green-800');
    selectedGerman = null;
    selectedRussian = null;
  }

  function markMatched(btn1, btn2) {
    btn1.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    btn1.classList.add('bg-yellow-300', 'text-black');
    btn1.disabled = true;

    btn2.classList.remove('bg-green-600', 'hover:bg-green-700');
    btn2.classList.add('bg-yellow-300', 'text-black');
    btn2.disabled = true;
  }

  function showError() {
    errorMsg.classList.remove('opacity-0');
    setTimeout(() => {
      errorMsg.classList.add('opacity-0');
    }, 1000);
  }

  function checkMatch() {
    if (!selectedGerman || !selectedRussian) return;

    const id1 = selectedGerman.dataset.id;
    const id2 = selectedRussian.dataset.id;

    if (id1 === id2) {
      score += 1;
      markMatched(selectedGerman, selectedRussian);
    } else {
      lifes -= 1;
      showError();
    }

    updateLifesAndScore();
    resetSelections();

    if (score >= limit) {
      gameControls.classList.remove('hidden');
    }
  }

  germanButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      if (selectedGerman) selectedGerman.classList.remove('bg-blue-800');
      selectedGerman = btn;
      btn.classList.add('bg-blue-800');
      checkMatch();
    });
  });

  russianButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      if (selectedRussian) selectedRussian.classList.remove('bg-green-800');
      selectedRussian = btn;
      btn.classList.add('bg-green-800');
      checkMatch();
    });
  });

  // –ö–Ω–æ–ø–∫–∞ "–°—Ç–æ–ø"
  stopBtn.addEventListener('click', () => {
    fetch('{% url "api:exercises:save_progress" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify({
        lifes: lifes,
        score: score,
      }),
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        window.location.href = '/api/exercises/'; // –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω—É–∂–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
      }
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞:', err);
    });
  });

  // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
    continueBtn.addEventListener('click', () => {
      fetch('{% url "api:exercises:save_progress" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
          lifes: lifes,
          score: score,
        }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'ok') {
          window.location.reload();  // –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
      });
    });

});
</script>


{% endblock %}